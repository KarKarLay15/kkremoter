
<!-- Firebase Extended Template: Auth Verification, Role Access, Cloud Functions Ready -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    sendEmailVerification,
    signOut
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import {
    getDatabase,
    ref,
    set,
    push,
    onValue,
    update,
    remove,
    get
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDNy9pEyEr7V9drQacMkYNeZ6HFWYsHebQ",
    authDomain: "kkremoter-c6448.firebaseapp.com",
    databaseURL: "https://kkremoter-c6448-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "kkremoter-c6448",
    storageBucket: "kkremoter-c6448.appspot.com",
    messagingSenderId: "858612772940",
    appId: "1:858612772940:web:155da975ef648121cf04e9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  document.getElementById("loginForm")?.addEventListener("submit", function (e) {
    e.preventDefault();
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;

    signInWithEmailAndPassword(auth, email, password)
      .then(async (userCredential) => {
        const user = userCredential.user;

        if (!user.emailVerified) {
          sendEmailVerification(user);
          alert("Please verify your email. Verification email sent.");
          signOut(auth);
          return;
        }

        const roleSnap = await get(ref(db, `roles/${user.uid}`));
        const role = roleSnap.exists() ? roleSnap.val() : "user";

        if (role !== "admin") {
          alert("Access denied. Admins only.");
          signOut(auth);
          return;
        }

        document.getElementById("loginPage").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
        fetchAllData();
      })
      .catch(err => alert("Login failed: " + err.message));
  });

  function createItem(path, data) {
    const newRef = push(ref(db, path));
    return set(newRef, data);
  }

  function fetchAllData() {
    const paths = ["users", "orders", "services"];
    paths.forEach(path => {
      const container = document.getElementById(path + "Table");
      if (!container) return;
      container.innerHTML = "";
      onValue(ref(db, path), snapshot => {
        container.innerHTML = "";
        snapshot.forEach(child => {
          const val = child.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${val.name || val.service || "-"}</td>
            <td>${val.email || val.amount || "-"}</td>
            <td>${val.status}</td>
            <td>
              <button onclick="editItem('${path}', '${child.key}')">✏️</button>
              <button onclick="deleteItem('${path}', '${child.key}')">🗑️</button>
            </td>`;
          container.appendChild(tr);
        });
      });
    });
  }

  window.editItem = function (path, key) {
    const newVal = prompt("Enter new value:");
    if (newVal) {
      update(ref(db, `${path}/${key}`), { name: newVal });
    }
  };

  window.deleteItem = function (path, key) {
    if (confirm("Delete this item?")) {
      remove(ref(db, `${path}/${key}`));
    }
  };

  document.getElementById("addUserBtn")?.addEventListener("click", () => {
    createItem("users", {
      name: "User Name",
      email: "user@example.com",
      status: "active"
    });
  });

  document.getElementById("addServiceBtn")?.addEventListener("click", () => {
    createItem("services", {
      name: "Service Name",
      price: 10,
      status: "active"
    });
  });

  document.getElementById("newOrderBtnOrders")?.addEventListener("click", () => {
    createItem("orders", {
      service: "Service A",
      amount: 25,
      status: "pending",
      created: new Date().toISOString()
    });
  });
</script>
